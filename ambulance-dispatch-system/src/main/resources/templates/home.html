<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Ambulance Dispatch System</title>
  <style>
  /* üî∑ Base Layout */
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    background: #eef4f9;
    color: #333;
  }

  h1 {
    text-align: center;
    color: #007bff;
    margin: 28px 0 12px;
    font-size: 2.3em;
    letter-spacing: 1px;
  }

  /* üî∑ Navigation Bar */
  nav {
    background: #004080;
    padding: 12px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  nav button {
    background: none;
    border: none;
    color: white;
    font-weight: bold;
    font-size: 1em;
    margin: 0 10px;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.2s;
  }

  nav button:hover {
    background: rgba(255,255,255,0.2);
  }

  /* üî∑ Section Container */
  .section {
    margin: 20px auto;
    padding: 28px 36px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
    max-width: 900px;
  }

  .section h2 {
    color: #007bff;
    margin-bottom: 18px;
    font-size: 1.45em;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 4px;
  }

  /* üî∑ Form Group Spacing */
  .form-group {
    margin: 8px 0;
  }

  label {
    display: block;
    font-weight: 500;
    color: #444;
    margin-bottom: 6px;
  }

  input, select {
    padding: 9px;
    width: 100%;
    border: 1px solid #bbb;
    border-radius: 6px;
    font-size: 1em;
    margin-bottom: 8px;
    background: #f7fbff;
    transition: border 0.2s;
  }

  input:focus, select:focus {
    border: 1.5px solid #007bff;
    outline: none;
    background: #fff;
  }

  /* üî∑ Buttons */
  button {
    padding: 10px 24px;
    background: linear-gradient(90deg,#007bff,#00c6ff);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.05em;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    transition: background 0.2s, box-shadow 0.2s;
  }

  button:hover {
    background: linear-gradient(90deg,#0056b3,#007bff);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  /* üî∑ Result Message Box */
  .result {
    margin: 5px 0;
    padding: 14px;
    background: #eaf6ff;
    border-radius: 8px;
    border-left: 5px solid #007bff;
    font-size: 1.08em;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
  }

  .error {
    color: #d32f2f;
    font-size: 1.05em;
  }

  /* üî∑ Tables */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 7px;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  }

  th {
    background: #007bff;
    color: #fff;
    font-weight: 600;
    padding: 12px;
    font-size: 1.05em;
    border-right: 1px solid #e0e0e0;
  }

  td {
    padding: 11px;
    text-align: left;
    font-size: 1em;
    vertical-align: top;
    border-right: 1px solid #f0f0f0;
    border-bottom: 1px solid #f0f0f0;
  }

  tbody tr:nth-child(even) {
    background: #f7fbff;
  }

  tbody tr:hover {
    background: #e3f2fd;
  }

  th.why, td.why {
    background: #fffbe6;
    color: #ff9800;
    border-left: 4px solid #ff9800;
  }

  /* üî∑ Refresh Button */
  .refresh-btn {
    float: right;
    margin-bottom: 6px;
    background: #fff;
    color: #007bff;
    border: 2px solid #007bff;
    border-radius: 6px;
    font-weight: 600;
    padding: 6px 16px;
    transition: background 0.2s, color 0.2s;
  }

  .refresh-btn:hover {
    background: #007bff;
    color: #fff;
  }

  /* üî∑ Notification Area */
  #notification-area {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 2000;
  }

  #notification-area > button {
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 10px 18px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  #notif-list {
    position: absolute;
    bottom: 50px;
    right: 0;
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  #notif-list div {
    padding: 8px 0;
    border-bottom: 1px dashed #eee;
  }

  #notif-list div:last-child {
    border-bottom: none;
  }

  #notif-list button {
    background: #007bff;
    color: white;
    padding: 4px 8px;
    margin-top: 4px;
    font-size: 0.8em;
    border-radius: 4px;
  }

  /* üî∑ Responsive Layout */
  @media (max-width: 900px) {
    .section { max-width: 98vw; padding: 16px; }
    input, select { width: 100%; }
    #historyTable td.why { max-width: 140px; font-size: 0.95em; }
  }
</style>
</head>
<body>
  <h1>üöë Ambulance Dispatch System</h1>

    <nav>
    <button onclick="showSection('hospital')">üè• Hospital</button>
    <button onclick="showSection('ambulance')">üöê Ambulance</button>
    <button onclick="showSection('request')">üö® Request</button>
    <button onclick="showSection('update')">üîÑ Update Status</button>
    <button onclick="showSection('dispatch')">üìú Dispatch</button>
    <button onclick="showSection('reassigned')">‚è≥ Reassigned</button>
    <button onclick="showSection('notifications')">üîî Notifications</button>
  </nav>

    <div id="hospital" class="section" style="display:block;">
    <h2>üè• Register Hospital</h2>
    <form id="hospitalForm" novalidate>
        <div class="form-group">
            <label for="hospitalName">Hospital Name:</label>
            <input type="text" id="hospitalName" required>
        </div>
        <div class="form-group">
            <label for="hospitalLocation">Location:</label>
            <input type="text" id="hospitalLocation" required>
        </div>
        <div class="form-group">
            <label for="hospitalPincode">Pincode:</label>
            <input type="text" id="hospitalPincode" required pattern="\d{6}" maxlength="6" title="Enter a 6-digit pincode">
        </div>
        <div class="form-group">
            <label for="availableBeds">Available Beds:</label>
            <input type="number" id="availableBeds" required min="0" title="Enter a non-negative number">
        </div>
        <button type="submit">Register Hospital</button>
    </form>
    <div id="hospitalResult" class="result" style="display: none;"></div>

    
    <h2>üè• Hospital List</h2>
    <button class="refresh-btn" onclick="loadHospitals()">üîÑ Refresh</button>
    <table id="hospitalTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Location</th>
                <th>Pincode</th>
                <th>Available Beds</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>

  <div id="ambulance" class="section" style="display:none;">
    <h2>üöê Register Ambulance</h2>
    <form id="ambulanceForm" novalidate>
        <div class="form-group">
            <label for="ambulanceId">Ambulance ID:</label>
            <!-- Enforce new rule: uppercase A followed by 1-6 digits -->
            <input type="text" id="ambulanceId" required pattern="^A\d{1,6}$" maxlength="7" title="Must start with capital A followed by digits, e.g., A10">
        </div>
        <div class="form-group">
            <label for="ambulanceHospital">Hospital ID:</label>
            <input type="text" id="ambulanceHospital" required>
        </div>
        <div class="form-group">
            <label for="ambulanceLocation">Location:</label>
            <input type="text" id="ambulanceLocation" required>
        </div>
        <div class="form-group">
            <label for="ambulancePincode">Pincode:</label>
            <input type="text" id="ambulancePincode" required pattern="\d{6}" maxlength="6" title="Enter a 6-digit pincode">
        </div>
        <div class="form-group">
            <label for="driverName">Driver Name:</label>
            <input type="text" id="driverName" required>
        </div>
        <div class="form-group">
            <label for="driverPhone">Driver Phone:</label>
            <input type="text" id="driverPhone" required pattern="\d{10}" maxlength="10" title="Enter a 10-digit phone number">
        </div>
        <button type="submit">Register Ambulance</button>
    </form>
    <div id="ambulanceResult" class="result" style="display: none;"></div>

    <h2>üìä Ambulance List</h2>
    <button class="refresh-btn" onclick="loadAmbulances()">üîÑ Refresh</button>
    <table id="ambulanceTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Hospital ID</th>
                <th>Location</th>
                <th>Pincode</th>
                <th>Driver</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>

  <div id="request" class="section" style="display:none;">
    <h2>üö® New Emergency Request</h2>
    <form id="emergencyForm" novalidate>
        <div class="form-group">
            <label for="patientName">Patient Name:</label>
            <input type="text" id="patientName" required>
        </div>
        <div class="form-group">
            <label for="contactNo">Contact Number:</label>
            <input type="text" id="contactNo" required pattern="\d{10}" maxlength="10" title="Enter a 10-digit phone number">
        </div>
        <div class="form-group">
            <label for="emergencyType">Emergency Type:</label>
            <select id="emergencyType" required>
                <option value="CRITICAL">Critical</option>
                <option value="MAJOR">Major</option>
                <option value="MINOR">Minor</option>
                <option value="OTHER">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label for="patientLocation">Patient Location:</label>
            <input type="text" id="patientLocation" required>
        </div>
        <div class="form-group">
            <label for="patientPincode">Patient Pincode:</label>
            <input type="text" id="patientPincode" required pattern="\d{6}" maxlength="6" title="Enter a 6-digit pincode">
        </div>
        <button type="submit">Create Emergency Request</button>
    </form>
    <div id="emergencyResult" class="result" style="display: none;"></div>
  </div>

  <div id="update" class="section" style="display:none;">
    <h2>üöê Update Ambulance Status</h2>
    <form id="updateAmbulanceForm" novalidate>
        <label for="updateAmbulanceId">Ambulance ID:</label>
        <input type="text" id="updateAmbulanceId" required pattern="[A-Za-z0-9\-]{2,30}" title="3-30 characters; letters, digits and hyphen allowed">
        <label for="ambulanceStatus">Status:</label>
        <select id="ambulanceStatus">
            <option value="AVAILABLE">AVAILABLE</option>
            <option value="BUSY">BUSY</option>
            <option value="OFFLINE">OFFLINE</option>
        </select>
        <button type="submit">Update</button>
    </form>
    <div id="updateResult" class="result" style="display: none;"></div>
  </div>

  <div id="dispatch" class="section" style="display:none;">
    <h2>üìú Dispatch History</h2>
    <button class="refresh-btn" onclick="loadDispatchHistory()">üîÑ Refresh</button>
    <table id="historyTable">
        <thead>
            <tr>
                <th>Request ID</th>
                <th>Patient</th>
                <th>Ambulance</th>
                <th>Hospital</th>
                <th class="why">Outcome</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>

  <div id="reassigned" class="section" style="display:none;">
    <h2>‚è≥ Reassigned Emergencies</h2>
    <button class="refresh-btn" onclick="loadReassigned()">üîÑ Refresh</button>
    <table id="reassignedTable">
        <thead>
            <tr>
                <th>Request ID</th>
                <th>Patient</th>
                <th>Ambulance</th>
                <th>Hospital</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>

  <div id="notifications" class="section" style="display:none;">
    <h2>üîî Notifications</h2>
    <div id="notification-content">
        <p>Notifications will appear here. The floating button is also available.</p>
    </div>
  </div>
    
   <div id="notification-area">
    <button onclick="toggleNotifications()">üîî Notifications (<span id="notif-count">0</span>)</button>
    <div id="notif-list" style="display:none;"></div>
  </div>

    <script>
    function showSection(id) {
      const sections = ['hospital','ambulance','request','update','dispatch','reassigned','notifications'];
      sections.forEach(s => {
        document.getElementById(s).style.display = (s === id) ? 'block' : 'none';
      });
      if (id === 'hospital') loadHospitals();
      if (id === 'ambulance') loadAmbulances();
      if (id === 'dispatch') loadDispatchHistory();
      if (id === 'reassigned') loadReassigned();
      if (id === 'notifications') fetchNotifications();
    }

    const hospitalResult = document.getElementById('hospitalResult');
    const ambulanceResult = document.getElementById('ambulanceResult');
    const updateResult = document.getElementById('updateResult');
    const emergencyResult = document.getElementById('emergencyResult');

    // Helper: show validation message from HTML5 validity or custom
    function showFormError(resultElem, message) {
      resultElem.style.display = 'block';
      resultElem.innerHTML = `<span class="error">‚ùå ${message}</span>`;
    }

    // Hospital Registration
    document.getElementById('hospitalForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const hospital = {
            name: document.getElementById('hospitalName').value.trim(),
            location: document.getElementById('hospitalLocation').value.trim(),
            pincode: document.getElementById('hospitalPincode').value.trim(),
            availableBeds: parseInt(document.getElementById('availableBeds').value, 10)
        };
        fetch('/api/hospital/add', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(hospital)})
        .then(async res=>{
          if(!res.ok) {
            const text = await res.text();
            showFormError(hospitalResult, text || 'Failed to register hospital');
            return;
          }
          return res.json();
        })
        .then(()=>{ hospitalResult.style.display='block'; hospitalResult.innerHTML='‚úÖ Hospital registered successfully!'; form.reset(); loadHospitals(); });
    });

    // Ambulance Registration (with frontend unique-id check and A... rule)
    document.getElementById('ambulanceForm').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const ambulanceIdRaw = document.getElementById('ambulanceId').value.trim();
        const ambulanceId = ambulanceIdRaw.toUpperCase();

        // Enforce pattern client-side: A followed by 1-6 digits
        const re = /^A\d{1,6}$/;
        if (!re.test(ambulanceId)) {
          showFormError(ambulanceResult, 'Ambulance ID invalid. It must start with capital A followed by digits (e.g., A10).');
          return;
        }

        // Optional: frontend check for duplicate ID using backend endpoint (if implemented)
        try {
          const existsRes = await fetch(`/api/ambulance/exists?ambulanceId=${encodeURIComponent(ambulanceId)}`);
          if (existsRes.ok) {
            const existsData = await existsRes.json();
            if (existsData.exists) {
              showFormError(ambulanceResult, `Ambulance ID "${ambulanceId}" already exists. Choose a different ID.`);
              return;
            }
          }
        } catch (err) {
          // ignore if endpoint not available; server-side will validate anyway
          console.warn('exists check failed', err);
        }

        const ambulance = {
            ambulanceId,
            hospitalId: document.getElementById('ambulanceHospital').value.trim(),
            location: document.getElementById('ambulanceLocation').value.trim(),
            pincode: document.getElementById('ambulancePincode').value.trim(),
            driverName: document.getElementById('driverName').value.trim(),
            driverPhone: document.getElementById('driverPhone').value.trim(),
            status:'AVAILABLE'
        };
        fetch('/api/ambulance/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(ambulance)})
        .then(async res=>{
          if(!res.ok) {
            const text = await res.text();
            showFormError(ambulanceResult, text || 'Failed to register ambulance');
            return;
          }
          return res.json();
        })
        .then(()=>{ ambulanceResult.style.display='block'; ambulanceResult.innerHTML='‚úÖ Ambulance registered successfully!'; form.reset(); loadAmbulances(); });
    });

    // Emergency Request
    document.getElementById('emergencyForm').addEventListener('submit', e=>{
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const pincodeVal = document.getElementById('patientPincode').value.trim();
        const pincode = parseInt(pincodeVal, 10);
        if(isNaN(pincode) || pincode < 600001 || pincode > 600130){
            emergencyResult.style.display='block';
            emergencyResult.innerHTML=`<span style="color:#d32f2f;font-size:1.15em;">‚ùå Sorry, our service is not available for pincode <b>${pincodeVal}</b>.<br><span style="color:#007bff;">We only serve Chennai (600001-600130).</span></span>`;
            return;
        }
        const request={
            patientName: document.getElementById('patientName').value.trim(),
            contactNo: document.getElementById('contactNo').value.trim(),
            emergencyType: document.getElementById('emergencyType').value,
            patientLocation: document.getElementById('patientLocation').value.trim(),
            pincode
        };
        fetch('/api/emergency/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(request)})
        .then(async res=>{
          if(!res.ok) {
            const text = await res.text();
            showFormError(emergencyResult, text || 'Failed to create emergency request');
            return;
          }
          return res.json();
        })
        .then(data=>{
            if(!data) return;
            emergencyResult.style.display='block';
            if(data.status==='ASSIGNED'){
                emergencyResult.innerHTML=`<div style="font-size:1.1em;">
                <span style="font-size:1.3em;">üö® Emergency Request Created!</span><br>
                <span>Status: <b style="color:#007bff">${data.status}</b></span><br><br>
                <span style="color:#28a745;">‚úÖ Assignment Details:</span><br>
                <b>Patient Pincode:</b> ${data.pincode}<br>
                üöê <b>Ambulance:</b> ${data.assignedAmbulance.ambulanceId}<br>
                üë®‚Äç‚úà <b>Driver:</b> ${data.assignedAmbulance.driverName} <span style="color:#007bff;">(üìû ${data.assignedAmbulance.driverPhone})</span><br>
                <b>Ambulance Pincode:</b> ${data.assignedAmbulance.pincode}<br>
                üöê<b>Estimated Arrival:</b> ${data.etaMinutes} minutes<br>
                üè• <b>Hospital:</b> ${data.assignedHospital.name} <span style="color:#007bff;">(Beds Left: ${data.assignedHospital.availableBeds})</span><br>
                <b>Hospital Pincode:</b> ${data.assignedHospital.pincode}<br>
                <span style="color:#ff9800;">üìå Why:</span> Nearest ambulance and hospital with available beds.
                </div>`;
            } else {
                emergencyResult.innerHTML=`<span style="font-size:1.2em;">üö® Emergency Request Created! Status: <b>${data.status}</b></span>`;
            }
            form.reset();
            loadAmbulances(); loadHospitals(); loadDispatchHistory();
        });
    });

    // Update Ambulance Status
    document.getElementById("updateAmbulanceForm").addEventListener("submit", e=>{
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const ambulanceId=document.getElementById("updateAmbulanceId").value.trim();
        const status=document.getElementById("ambulanceStatus").value;
        fetch(`/api/ambulance/update-status?ambulanceId=${encodeURIComponent(ambulanceId)}&status=${encodeURIComponent(status)}`,{method:"POST"})
        .then(async res=>{
          const text = await res.text();
          updateResult.style.display='block';
          updateResult.innerText = text;
          loadAmbulances();
        });
    });

    // Load Ambulances
    function loadAmbulances(){ fetch('/api/ambulance/all').then(res=>res.json()).then(data=>{
        const tbody=document.querySelector("#ambulanceTable tbody"); tbody.innerHTML="";
        data.forEach(a=>{ tbody.innerHTML+=`<tr>
            <td><b>${a.ambulanceId}</b></td>
            <td>${a.hospitalId}</td>
            <td>${a.location}</td>
            <td>${a.pincode}</td>
            <td>${a.driverName}</td>
            <td><span style="color:${a.status==='AVAILABLE'?'#28a745':'#d32f2f'}">${a.status}</span></td>
        </tr>`; });
    }); }

    // Load Hospitals
    function loadHospitals() {
        fetch('/api/hospital/all')
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector("#hospitalTable tbody");
                tbody.innerHTML = "";
                data.forEach(h => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${h.id}</td>
                        <td><b>${h.name}</b></td>
                        <td>${h.location}</td>
                        <td>${h.pincode}</td>
                        <td>${h.availableBeds}</td>
                        <td><button onclick="deleteHospital('${h.id}')">üóëÔ∏è Delete</button></td>
                    </tr>`;
                });
            });
    }

    // Delete Hospital by ID
    function deleteHospital(id) {
        if (confirm("Are you sure you want to delete this hospital?")) {
            fetch(`/api/hospital/delete/${id}`, { method: "DELETE" })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    loadHospitals();
                });
        }
    }

    // Load Dispatch History
    function loadDispatchHistory(){ fetch('/api/dispatch/history').then(res=>res.json()).then(data=>{
        const tbody=document.querySelector("#historyTable tbody"); tbody.innerHTML="";
        data.forEach(d=>{ tbody.innerHTML+=`<tr>
            <td>${d.requestId}</td>
            <td>${d.patientName} (${d.patientPincode})</td>
            <td><b>${d.ambulanceId||'N/A'}</b></td>
            <td>${d.hospitalName||'N/A'}</td>
            <td class="why">${d.outcome}</td>
            <td>${d.dispatchTime ? new Date(d.dispatchTime.replace(' ', 'T')).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'}</td>
        </tr>`; });
    }); }

    // Load Reassigned Emergencies
    function loadReassigned() {
        fetch('/dispatch/reassigned')
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector("#reassignedTable tbody");
                tbody.innerHTML = "";
                data.forEach(d => {
                    tbody.innerHTML += `<tr>
                        <td>${d.requestId}</td>
                        <td>${d.patientName} (${d.patientPincode})</td>
                        <td><b>${d.ambulanceId || 'N/A'}</b></td>
                        <td>${d.hospitalName || 'N/A'}</td>
                        <td>${d.dispatchTime ? new Date(d.dispatchTime.replace(' ', 'T')).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'}</td>
                    </tr>`;
                });
            });
    }

    // Notification Logic
    function toggleNotifications() {
      const list = document.getElementById('notif-list');
      list.style.display = list.style.display === 'none' ? 'block' : 'none';
    }

    async function fetchNotifications() {
      try {
        const res = await fetch('/api/notifications/unread');
        const data = await res.json();

        const count = Array.isArray(data) ? data.length : 0;
        document.getElementById('notif-count').textContent = count;
        document.getElementById('notification-content').innerHTML = `<h3>Unread Notifications: ${count}</h3>`;

        const list = document.getElementById('notif-list');
        list.innerHTML = data.map(n => `
          <div>
            <strong>${n.title}</strong><br>
            ${n.message}<br>
            <button onclick="markRead('${n.id}')">Mark as read</button>
            <hr>
          </div>
        `).join('');

        document.getElementById('notification-content').innerHTML += data.map(n => `
          <div class="result">
            <strong>${n.title}</strong> - ${new Date(n.timestamp).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' })}<br>
            ${n.message}<br>
            <button onclick="markRead('${n.id}')">Mark as read</button>
          </div>
        `).join('');

      } catch (err) {
        console.error("Notification fetch failed:", err);
        document.getElementById('notif-count').textContent = "!";
      }
    }

    async function markRead(id) {
      await fetch('/api/notifications/' + id + '/read', { method: 'POST' });
      fetchNotifications();
    }

    // Auto-refresh notifications and initial load
    setInterval(fetchNotifications, 7000);
    
    // Initial Load functions (runs on page load)
    window.onload = () => {
      loadHospitals();
      loadAmbulances();
      loadDispatchHistory();
      loadReassigned();
      fetchNotifications();
    };
    </script>
</body>
</html>
