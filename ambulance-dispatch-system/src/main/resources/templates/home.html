<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Ambulance Dispatch System</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background: #f4f8fb;
        }
        h1 { text-align: center; color: #007bff; margin-top: 32px; font-size: 2.5em; letter-spacing: 2px; }
        .section { margin: 32px auto; padding: 32px 40px; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 900px; }
        .section h2 { color: #007bff; margin-bottom: 22px; font-size: 1.5em; letter-spacing: 1px; }
        .form-group { margin: 18px 0; }
        label { display: block; font-weight: 500; color: #444; margin-bottom: 6px; }
        input, select { padding: 10px; width: 100%; border: 1px solid #bbb; border-radius: 6px; font-size: 1em; margin-bottom: 8px; background: #f7fbff; transition: border 0.2s; }
        input:focus, select:focus { border: 1.5px solid #007bff; outline: none; }
        button { padding: 12px 28px; background: linear-gradient(90deg,#007bff,#00c6ff); color: white; border: none; border-radius: 7px; cursor: pointer; font-weight: 600; font-size: 1.08em; box-shadow: 0 2px 8px rgba(0,0,0,0.07); transition: background 0.2s, box-shadow 0.2s; }
        button:hover { background: linear-gradient(90deg,#0056b3,#007bff); box-shadow: 0 4px 16px rgba(0,0,0,0.10); }
        .result { margin: 18px 0; padding: 16px; background: #eaf6ff; border-radius: 8px; border-left: 6px solid #007bff; font-size: 1.12em; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: none; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 18px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th { background: #007bff; color: #fff; font-weight: 600; padding: 14px; font-size: 1.08em; border-right: 1px solid #e0e0e0; }
        td { padding: 13px; text-align: left; font-size: 1.05em; vertical-align: top; border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
        tbody tr:nth-child(even) { background: #f7fbff; }
        tbody tr:hover { background: #e3f2fd; }
        .refresh-btn { float: right; margin-bottom: 8px; background: #fff; color: #007bff; border: 2px solid #007bff; border-radius: 6px; font-weight: 600; padding: 7px 18px; transition: background 0.2s, color 0.2s; }
        .refresh-btn:hover { background: #007bff; color: #fff; }
        #historyTable td.why { max-width: 350px; word-break: break-word; color: #ff9800; font-size: 1em; background: #fffbe6; border-left: 4px solid #ff9800; }
        #historyTable th.why { background: #ff9800; color: #fff; }
        @media (max-width: 900px) {
            .section { max-width: 98vw; padding: 16px; }
            input, select { width: 100%; }
            #historyTable td.why { max-width: 140px; font-size: 0.95em; }
        }
    </style>
</head>
<body>
    <h1>üöë Ambulance Dispatch System</h1>

    <!-- Hospital Registration -->
    <div class="section">
        <h2>üè• Register Hospital</h2>
        <form id="hospitalForm">
            <div class="form-group">
                <label for="hospitalName">Hospital Name:</label>
                <input type="text" id="hospitalName" required>
            </div>
            <div class="form-group">
                <label for="hospitalLocation">Location:</label>
                <input type="text" id="hospitalLocation" required>
            </div>
            <div class="form-group">
                <label for="hospitalPincode">Pincode:</label>
                <input type="text" id="hospitalPincode" required>
            </div>
            <div class="form-group">
                <label for="availableBeds">Available Beds:</label>
                <input type="number" id="availableBeds" required>
            </div>
            <button type="submit">Register Hospital</button>
        </form>
        <div id="hospitalResult" class="result"></div>
    </div>

    <!-- Ambulance Registration -->
    <div class="section">
        <h2>üöê Register Ambulance</h2>
        <form id="ambulanceForm">
            <div class="form-group">
                <label for="ambulanceId">Ambulance ID:</label>
                <input type="text" id="ambulanceId" required>
            </div>
            <div class="form-group">
                <label for="ambulanceHospital">Hospital ID:</label>
                <input type="text" id="ambulanceHospital" required>
            </div>
            <div class="form-group">
                <label for="ambulanceLocation">Location:</label>
                <input type="text" id="ambulanceLocation" required>
            </div>
            <div class="form-group">
                <label for="ambulancePincode">Pincode:</label>
                <input type="text" id="ambulancePincode" required>
            </div>
            <div class="form-group">
                <label for="driverName">Driver Name:</label>
                <input type="text" id="driverName" required>
            </div>
            <div class="form-group">
                <label for="driverPhone">Driver Phone:</label>
                <input type="text" id="driverPhone" required>
            </div>
            <button type="submit">Register Ambulance</button>
        </form>
        <div id="ambulanceResult" class="result"></div>
    </div>

    <!-- Emergency Request -->
    <div class="section">
        <h2>üö® New Emergency Request</h2>
        <form id="emergencyForm">
            <div class="form-group">
                <label for="patientName">Patient Name:</label>
                <input type="text" id="patientName" required>
            </div>
            <div class="form-group">
                <label for="contactNo">Contact Number:</label>
                <input type="text" id="contactNo" required>
            </div>
            <div class="form-group">
                <label for="emergencyType">Emergency Type:</label>
                <select id="emergencyType" required>
                    <option value="CRITICAL">Critical</option>
                    <option value="MAJOR">Major</option>
                    <option value="MINOR">Minor</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="patientLocation">Patient Location:</label>
                <input type="text" id="patientLocation" required>
            </div>
            <div class="form-group">
                <label for="patientPincode">Patient Pincode:</label>
                <input type="text" id="patientPincode" required>
            </div>
            <button type="submit">Create Emergency Request</button>
        </form>
        <div id="emergencyResult" class="result"></div>
    </div>

    <!-- Update Ambulance Status -->
    <div class="section">
        <h2>üöê Update Ambulance Status</h2>
        <form id="updateAmbulanceForm">
            <label for="updateAmbulanceId">Ambulance ID:</label>
            <input type="text" id="updateAmbulanceId" required>
            <label for="ambulanceStatus">Status:</label>
            <select id="ambulanceStatus">
                <option value="AVAILABLE">AVAILABLE</option>
                <option value="BUSY">BUSY</option>
                <option value="OFFLINE">OFFLINE</option>
            </select>
            <button type="submit">Update</button>
        </form>
        <div id="updateResult" class="result"></div>
    </div>

    <!-- Ambulance List -->
    <div class="section">
        <h2>üìä Ambulance List</h2>
        <button class="refresh-btn" onclick="loadAmbulances()">üîÑ Refresh</button>
        <table id="ambulanceTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Hospital ID</th>
                    <th>Location</th>
                    <th>Pincode</th>
                    <th>Driver</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Hospital List -->
    <div class="section">
        <h2>üè• Hospital List</h2>
        <button class="refresh-btn" onclick="loadHospitals()">üîÑ Refresh</button>
        <table id="hospitalTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Pincode</th>
                    <th>Available Beds</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Dispatch History -->
    <div class="section">
        <h2>üìú Dispatch History</h2>
        <button class="refresh-btn" onclick="loadDispatchHistory()">üîÑ Refresh</button>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Request ID</th>
                    <th>Patient</th>
                    <th>Ambulance</th>
                    <th>Hospital</th>
                    <th>Outcome</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

<script>
const hospitalResult = document.getElementById('hospitalResult');
const ambulanceResult = document.getElementById('ambulanceResult');
const emergencyResult = document.getElementById('emergencyResult');
const updateResult = document.getElementById('updateResult');

// Hospital Registration
document.getElementById('hospitalForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const hospital = {
        name: hospitalName.value,
        location: hospitalLocation.value,
        pincode: hospitalPincode.value,
        availableBeds: parseInt(availableBeds.value)
    };
    fetch('/api/hospital/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(hospital)
    })
    .then(res => res.json())
    .then(() => {
        hospitalResult.style.display = 'block';
        hospitalResult.innerHTML = '‚úÖ Hospital registered successfully!';
        this.reset();
        loadHospitals();
    }).catch(err => console.error(err));
});

// Ambulance Registration
document.getElementById('ambulanceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const ambulance = {
        ambulanceId: ambulanceId.value,
        hospitalId: ambulanceHospital.value,
        location: ambulanceLocation.value,
        pincode: ambulancePincode.value,
        driverName: driverName.value,
        driverPhone: driverPhone.value,
        status: 'AVAILABLE'
    };
    fetch('/api/ambulance/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(ambulance)
    })
    .then(res => res.json())
    .then(() => {
        ambulanceResult.style.display = 'block';
        ambulanceResult.innerHTML = '‚úÖ Ambulance registered successfully!';
        this.reset();
        loadAmbulances();
    }).catch(err => console.error(err));
});

// Emergency Request
document.getElementById('emergencyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const request = {
        patientName: patientName.value,
        contactNo: contactNo.value,
        emergencyType: emergencyType.value,
        patientLocation: patientLocation.value,
        pincode: patientPincode.value
    };
    fetch('/api/emergency/new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(request)
    })
    .then(res => res.json())
    .then(data => {
        emergencyResult.style.display = 'block';
        if (data.status === 'ASSIGNED') {
            emergencyResult.innerHTML = `
                üö® Assigned to Ambulance ${data.assignedAmbulance.ambulanceId} (Driver: ${data.assignedAmbulance.driverName})
                <br>Hospital: ${data.assignedHospital.name} (Beds Left: ${data.assignedHospital.availableBeds})
            `;
        } else {
            emergencyResult.innerHTML = `Status: ${data.status}`;
        }
        this.reset();
        loadAmbulances();
        loadDispatchHistory();
    }).catch(err => console.error(err));
});

// Update Ambulance Status
document.getElementById("updateAmbulanceForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const ambulanceId = document.getElementById("updateAmbulanceId").value;
    const status = document.getElementById("ambulanceStatus").value;
    fetch(`/api/ambulance/update-status?ambulanceId=${ambulanceId}&status=${status}`, { method: "POST" })
    .then(res => res.text())
    .then(msg => {
        updateResult.style.display = 'block';
        updateResult.innerText = msg;
        loadAmbulances();
    }).catch(err => console.error(err));
});

// Load Ambulances
function loadAmbulances() {
    fetch('/api/ambulance/all')
    .then(res => res.json())
    .then(data => {
        const tbody = document.querySelector("#ambulanceTable tbody");
        tbody.innerHTML = "";
        data.forEach(a => {
            tbody.innerHTML += `
                <tr>
                    <td><b>${a.ambulanceId}</b></td>
                    <td>${a.hospitalId}</td>
                    <td>${a.location}</td>
                    <td>${a.pincode}</td>
                    <td>${a.driverName}</td>
                    <td><span style="color:${a.status==='AVAILABLE'?'#28a745':'#d32f2f'}">${a.status}</span></td>
                </tr>`;
        });
    }).catch(err => console.error(err));
}

// Load Hospitals
function loadHospitals() {
    fetch('/api/hospital/all')
    .then(res => res.json())
    .then(data => {
        const tbody = document.querySelector("#hospitalTable tbody");
        tbody.innerHTML = "";
        data.forEach(h => {
            tbody.innerHTML += `
                <tr>
                    <td><b>${h.name}</b></td>
                    <td>${h.location}</td>
                    <td>${h.pincode}</td>
                    <td><span style="color:#007bff;">${h.availableBeds}</span></td>
                </tr>`;
        });
    }).catch(err => console.error(err));
}

// Load Dispatch History
function loadDispatchHistory() {
    fetch('/api/dispatch/history')
    .then(res => res.json())
    .then(data => {
        const tbody = document.querySelector("#historyTable tbody");
        tbody.innerHTML = "";
        data.forEach(d => {
            tbody.innerHTML += `
                <tr>
                    <td>${d.requestId}</td>
                    <td>${d.patientName} (${d.patientPincode})</td>
                    <td><b>${d.ambulanceId}</b><br><span style="color:#007bff;">${d.driverName || 'N/A'}</span></td>
                    <td><b>${d.hospitalName || d.hospitalId}</b></td>
                    <td>${d.outcome}</td>
                    <td>${d.dispatchTime}</td>
                </tr>`;
        });
    }).catch(err => console.error(err));
}

// Auto-load on page load
loadAmbulances();
loadHospitals();
loadDispatchHistory();
</script>
</body>
</html>
