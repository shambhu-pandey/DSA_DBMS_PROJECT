<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Ambulance Dispatch System</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f4f8fb; }
        h1 { text-align: center; color: #007bff; margin-top: 32px; font-size: 2.5em; letter-spacing: 2px; }
        .section { margin: 32px auto; padding: 32px 40px; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 900px; }
        .section h2 { color: #007bff; margin-bottom: 22px; font-size: 1.5em; letter-spacing: 1px; }
        .form-group { margin: 18px 0; }
        label { display: block; font-weight: 500; color: #444; margin-bottom: 6px; }
        input, select { padding: 10px; width: 100%; border: 1px solid #bbb; border-radius: 6px; font-size: 1em; margin-bottom: 8px; background: #f7fbff; transition: border 0.2s; }
        input:focus, select:focus { border: 1.5px solid #007bff; outline: none; }
        button { padding: 12px 28px; background: linear-gradient(90deg,#007bff,#00c6ff); color: white; border: none; border-radius: 7px; cursor: pointer; font-weight: 600; font-size: 1.08em; box-shadow: 0 2px 8px rgba(0,0,0,0.07); transition: background 0.2s, box-shadow 0.2s; }
        button:hover { background: linear-gradient(90deg,#0056b3,#007bff); box-shadow: 0 4px 16px rgba(0,0,0,0.10); }
        .result { margin: 18px 0; padding: 16px; background: #eaf6ff; border-radius: 8px; border-left: 6px solid #007bff; font-size: 1.12em; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 18px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th { background: #007bff; color: #fff; font-weight: 600; padding: 14px; font-size: 1.08em; border-right: 1px solid #e0e0e0; }
        td { padding: 13px; text-align: left; font-size: 1.05em; vertical-align: top; border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
        tbody tr:nth-child(even) { background: #f7fbff; }
        tbody tr:hover { background: #e3f2fd; }
        .refresh-btn { float: right; margin-bottom: 8px; background: #fff; color: #007bff; border: 2px solid #007bff; border-radius: 6px; font-weight: 600; padding: 7px 18px; transition: background 0.2s, color 0.2s; }
        .refresh-btn:hover { background: #007bff; color: #fff; }
        #historyTable td.why { max-width: 350px; word-break: break-word; color: #ff9800; font-size: 1em; background: #fffbe6; border-left: 4px solid #ff9800; }
        #historyTable th.why { background: #ff9800; color: #fff; }
        @media (max-width: 900px) { .section { max-width: 98vw; padding: 16px; } input, select { width: 100%; } #historyTable td.why { max-width: 140px; font-size: 0.95em; } }
    </style>
</head>
<body>
    <h1>üöë Ambulance Dispatch System</h1>

    <!-- Hospital Registration -->
    <div class="section">
        <h2>üè• Register Hospital</h2>
        <form id="hospitalForm">
            <div class="form-group">
                <label for="hospitalName">Hospital Name:</label>
                <input type="text" id="hospitalName" required>
            </div>
            <div class="form-group">
                <label for="hospitalLocation">Location:</label>
                <input type="text" id="hospitalLocation" required>
            </div>
            <div class="form-group">
                <label for="hospitalPincode">Pincode:</label>
                <input type="text" id="hospitalPincode" required>
            </div>
            <div class="form-group">
                <label for="availableBeds">Available Beds:</label>
                <input type="number" id="availableBeds" required>
            </div>
            <button type="submit">Register Hospital</button>
        </form>
        <div id="hospitalResult" class="result" style="display: none;"></div>
    </div>

    <!-- Ambulance Registration -->
    <div class="section">
        <h2>üöê Register Ambulance</h2>
        <form id="ambulanceForm">
            <div class="form-group">
                <label for="ambulanceId">Ambulance ID:</label>
                <input type="text" id="ambulanceId" required>
            </div>
            <div class="form-group">
                <label for="ambulanceHospital">Hospital ID:</label>
                <input type="text" id="ambulanceHospital" required>
            </div>
            <div class="form-group">
                <label for="ambulanceLocation">Location:</label>
                <input type="text" id="ambulanceLocation" required>
            </div>
            <div class="form-group">
                <label for="ambulancePincode">Pincode:</label>
                <input type="text" id="ambulancePincode" required>
            </div>
            <div class="form-group">
                <label for="driverName">Driver Name:</label>
                <input type="text" id="driverName" required>
            </div>
            <div class="form-group">
                <label for="driverPhone">Driver Phone:</label>
                <input type="text" id="driverPhone" required>
            </div>
            <button type="submit">Register Ambulance</button>
        </form>
        <div id="ambulanceResult" class="result" style="display: none;"></div>
    </div>

    <!-- Emergency Request -->
    <div class="section">
        <h2>üö® New Emergency Request</h2>
        <form id="emergencyForm">
            <div class="form-group">
                <label for="patientName">Patient Name:</label>
                <input type="text" id="patientName" required>
            </div>
            <div class="form-group">
                <label for="contactNo">Contact Number:</label>
                <input type="text" id="contactNo" required>
            </div>
            <div class="form-group">
                <label for="emergencyType">Emergency Type:</label>
                <select id="emergencyType" required>
                    <option value="CRITICAL">Critical</option>
                    <option value="MAJOR">Major</option>
                    <option value="MINOR">Minor</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="patientLocation">Patient Location:</label>
                <input type="text" id="patientLocation" required>
            </div>
            <div class="form-group">
                <label for="patientPincode">Patient Pincode:</label>
                <input type="text" id="patientPincode" required>
            </div>
            <button type="submit">Create Emergency Request</button>
        </form>
        <div id="emergencyResult" class="result" style="display: none;"></div>
    </div>

    <!-- Update Ambulance Status -->
    <div class="section">
        <h2>üöê Update Ambulance Status</h2>
        <form id="updateAmbulanceForm">
            <label for="updateAmbulanceId">Ambulance ID:</label>
            <input type="text" id="updateAmbulanceId" required>
            <label for="ambulanceStatus">Status:</label>
            <select id="ambulanceStatus">
                <option value="AVAILABLE">AVAILABLE</option>
                <option value="BUSY">BUSY</option>
                <option value="OFFLINE">OFFLINE</option>
            </select>
            <button type="submit">Update</button>
        </form>
        <div id="updateResult" class="result" style="display: none;"></div>
    </div>

    <!-- Ambulance List -->
    <div class="section">
        <h2>üìä Ambulance List</h2>
        <button class="refresh-btn" onclick="loadAmbulances()">üîÑ Refresh</button>
        <table id="ambulanceTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Hospital ID</th>
                    <th>Location</th>
                    <th>Pincode</th>
                    <th>Driver</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Hospital List -->
    <div class="section">
      <h2>üè• Hospital List</h2>
        <button class="refresh-btn" onclick="loadHospitals()">üîÑ Refresh</button>
        <table id="hospitalTable">
            <thead>
                <tr>
                     <th>ID</th>
                <th>Name</th>
                <th>Location</th>
                <th>Pincode</th>
                <th>Available Beds</th>
                <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table> 

         
    </div>

    <!-- Dispatch History -->
    <div class="section">
        <h2>üìú Dispatch History</h2>
        <button class="refresh-btn" onclick="loadDispatchHistory()">üîÑ Refresh</button>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Request ID</th>
                    <th>Patient</th>
                    <th>Ambulance</th>
                    <th>Hospital</th>
                    <th>Outcome</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

     <!-- reassign emergency -->
<div class="section">
    <h2>‚è≥ Reassigned Emergencies</h2>
    <button class="refresh-btn" onclick="loadReassigned()">üîÑ Refresh</button>
    <table id="reassignedTable">
        <thead>
            <tr>
                <th>Request ID</th>
                <th>Patient</th>
                <th>Ambulance</th>
                <th>Hospital</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>


    <div id="notification-area">
  <button onclick="toggleNotifications()">Notifications (<span id="notif-count">0</span>)</button>
  <div id="notif-list" style="display:none;"></div>
</div>


    <script>
        const hospitalResult = document.getElementById('hospitalResult');
        const ambulanceResult = document.getElementById('ambulanceResult');
        const updateResult = document.getElementById('updateResult');
        const emergencyResult = document.getElementById('emergencyResult');

        // Hospital
        document.getElementById('hospitalForm').addEventListener('submit', e => {
            e.preventDefault();
            const hospital = {
                name: document.getElementById('hospitalName').value,
                location: document.getElementById('hospitalLocation').value,
                pincode: document.getElementById('hospitalPincode').value,
                availableBeds: parseInt(document.getElementById('availableBeds').value)
            };
            fetch('/api/hospital/add', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(hospital)})
            .then(res=>res.json()).then(()=>{ hospitalResult.style.display='block'; hospitalResult.innerHTML='‚úÖ Hospital registered successfully!'; e.target.reset(); loadHospitals(); });
        });

        // Ambulance
        document.getElementById('ambulanceForm').addEventListener('submit', e => {
            e.preventDefault();
            const ambulance = {
                ambulanceId: document.getElementById('ambulanceId').value,
                hospitalId: document.getElementById('ambulanceHospital').value,
                location: document.getElementById('ambulanceLocation').value,
                pincode: document.getElementById('ambulancePincode').value,
                driverName: document.getElementById('driverName').value,
                driverPhone: document.getElementById('driverPhone').value,
                status:'AVAILABLE'
            };
            fetch('/api/ambulance/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(ambulance)})
            .then(res=>res.json()).then(()=>{ ambulanceResult.style.display='block'; ambulanceResult.innerHTML='‚úÖ Ambulance registered successfully!'; e.target.reset(); loadAmbulances(); });
        });

        // Emergency Request
        document.getElementById('emergencyForm').addEventListener('submit', e=>{
            e.preventDefault();
            const pincode=parseInt(document.getElementById('patientPincode').value);
            if(isNaN(pincode) || pincode<600001 || pincode>600130){
                emergencyResult.style.display='block';
                emergencyResult.innerHTML=`<span style="color:#d32f2f;font-size:1.15em;">‚ùå Sorry, our service is not available for pincode <b>${pincode}</b>.<br><span style="color:#007bff;">We only serve Chennai (600001-600130).</span></span>`;
                return;
            }
            const request={
                patientName: document.getElementById('patientName').value,
                contactNo: document.getElementById('contactNo').value,
                emergencyType: document.getElementById('emergencyType').value,
                patientLocation: document.getElementById('patientLocation').value,
                pincode
            };
            fetch('/api/emergency/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(request)})
            .then(res=>res.json()).then(data=>{
                emergencyResult.style.display='block';
                if(data.status==='ASSIGNED'){
                    emergencyResult.innerHTML=`<div style="font-size:1.1em;">
                    <span style="font-size:1.3em;">üö® Emergency Request Created!</span><br>
                    <span>Status: <b style="color:#007bff">${data.status}</b></span><br><br>
                    <span style="color:#28a745;">‚úÖ Assignment Details:</span><br>
                    <b>Patient Pincode:</b> ${data.pincode}<br>
                    üöê <b>Ambulance:</b> ${data.assignedAmbulance.ambulanceId}<br>
                    üë®‚Äç‚úà <b>Driver:</b> ${data.assignedAmbulance.driverName} <span style="color:#007bff;">(üìû ${data.assignedAmbulance.driverPhone})</span><br>
                    <b>Ambulance Pincode:</b> ${data.assignedAmbulance.pincode}<br>
                    üöê<b>Estimated Arrival:</b> ${data.etaMinutes} minutes<br>
                    üè• <b>Hospital:</b> ${data.assignedHospital.name} <span style="color:#007bff;">(Beds Left: ${data.assignedHospital.availableBeds})</span><br>
                    <b>Hospital Pincode:</b> ${data.assignedHospital.pincode}<br>
                    <span style="color:#ff9800;">üìå Why:</span> Nearest ambulance and hospital with available beds.
                    </div>`;
                } else {
                    emergencyResult.innerHTML=`<span style="font-size:1.2em;">üö® Emergency Request Created! Status: <b>${data.status}</b></span>`;
                }
                e.target.reset();
                loadAmbulances(); loadHospitals(); loadDispatchHistory();
            });
        });

        // Update Ambulance Status
        document.getElementById("updateAmbulanceForm").addEventListener("submit", e=>{
            e.preventDefault();
            const ambulanceId=document.getElementById("updateAmbulanceId").value;
            const status=document.getElementById("ambulanceStatus").value;
            fetch(`/api/ambulance/update-status?ambulanceId=${ambulanceId}&status=${status}`,{method:"POST"})
            .then(res=>res.text()).then(msg=>{ updateResult.style.display='block'; updateResult.innerText=msg; loadAmbulances(); });
        });

        // Load Ambulances
        function loadAmbulances(){ fetch('/api/ambulance/all').then(res=>res.json()).then(data=>{
            const tbody=document.querySelector("#ambulanceTable tbody"); tbody.innerHTML="";
            data.forEach(a=>{ tbody.innerHTML+=`<tr>
                <td><b>${a.ambulanceId}</b></td>
                <td>${a.hospitalId}</td>
                <td>${a.location}</td>
                <td>${a.pincode}</td>
                <td>${a.driverName}</td>
                <td><span style="color:${a.status==='AVAILABLE'?'#28a745':'#d32f2f'}">${a.status}</span></td>
            </tr>`; });
        }); }

        // Load Hospitals
    
        // Load Hospitals
        function loadHospitals() {
            fetch('/api/hospital/all')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector("#hospitalTable tbody");
                    tbody.innerHTML = "";
                    data.forEach(h => {
                        tbody.innerHTML += `
                        <tr>
                            <td>${h.id}</td>
                            <td><b>${h.name}</b></td>
                            <td>${h.location}</td>
                            <td>${h.pincode}</td>
                            <td>${h.availableBeds}</td>
                            <td><button onclick="deleteHospital('${h.id}')">üóëÔ∏è Delete</button></td>
                        </tr>`;
                    });
                });
        }

        // Delete Hospital by ID
        function deleteHospital(id) {
            if (confirm("Are you sure you want to delete this hospital?")) {
                fetch(`/api/hospital/delete/${id}`, { method: "DELETE" })
                    .then(res => res.text())
                    .then(msg => {
                        alert(msg);
                        loadHospitals();
                    });
            }
        }










function toggleNotifications() {
  const list = document.getElementById('notif-list');
  list.style.display = list.style.display === 'none' ? 'block' : 'none';
}

async function fetchNotifications() {
  try {
    const res = await fetch('/api/notifications/unread');
    const data = await res.json();

    const count = Array.isArray(data) ? data.length : 0;
    document.getElementById('notif-count').textContent = count;

    const list = document.getElementById('notif-list');
    list.innerHTML = data.map(n => `
      <div>
        <strong>${n.title}</strong><br>
        ${n.message}<br>
        <button onclick="markRead('${n.id}')">Mark as read</button>
        <hr>
      </div>
    `).join('');
  } catch (err) {
    console.error("Notification fetch failed:", err);
    document.getElementById('notif-count').textContent = "!";
  }
}

async function markRead(id) {
  await fetch('/api/notifications/' + id + '/read', { method: 'POST' });
  fetchNotifications();
}

setInterval(fetchNotifications, 7000);
fetchNotifications();





function loadReassigned() {
    fetch('/dispatch/reassigned')
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector("#reassignedTable tbody");
            tbody.innerHTML = "";
            data.forEach(d => {
                tbody.innerHTML += `<tr>
                    <td>${d.requestId}</td>
                    <td>${d.patientName} (${d.patientPincode})</td>
                    <td><b>${d.ambulanceId || 'N/A'}</b></td>
                    <td>${d.hospitalName || 'N/A'}</td>
                    <td>${d.dispatchTime ? new Date(d.dispatchTime.replace(' ', 'T')).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'}</td>
                </tr>`;
            });
        });
}






        // Load on page start
        window.onload = loadHospitals;
    
        // Load Dispatch History
        function loadDispatchHistory(){ fetch('/api/dispatch/history').then(res=>res.json()).then(data=>{
            const tbody=document.querySelector("#historyTable tbody"); tbody.innerHTML="";
            data.forEach(d=>{ tbody.innerHTML+=`<tr>
                <td>${d.requestId}</td>
                <td>${d.patientName} (${d.patientPincode})</td>
                <td><b>${d.ambulanceId||'N/A'}</b></td>
                <td>${d.hospitalName||'N/A'}</td>
                <td class="why">${d.outcome}</td>
<td>${d.dispatchTime ? new Date(d.dispatchTime.replace(' ', 'T')).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'}</td>

            </tr>`; });
        }); }

        // Initial Load
        loadAmbulances(); loadHospitals(); loadDispatchHistory();
    </script>
</body>
</html>
